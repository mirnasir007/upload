<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shopify Bulk Importer Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .dropdown-menu { display: none; position: absolute; z-index: 50; width: 100%; background: white; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 4px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .dropdown-menu.show { display: block; }
        .product-card { border: 1px solid #e5e7eb; padding: 20px; margin-bottom: 24px; border-radius: 8px; transition: opacity 0.5s ease-out; }
        .img-grid { display: flex; gap: 12px; flex-wrap: wrap; margin: 12px 0; max-height: 350px; overflow-y: auto; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
        .img-item { position: relative; width: 80px; height: 80px; transition: 0.2s; cursor: grab; }
        .img-item:active { cursor: grabbing; }
        .img-item img { width: 100%; height: 100%; object-fit: cover; border: 2px solid #e5e7eb; border-radius: 6px; }
        .img-item img:hover { transform: scale(1.05); }
        .img-item .remove-btn { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; z-index: 10; }
        .img-item .view-btn { position: absolute; bottom: 0; left: 0; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; font-size: 14px; cursor: pointer; border-top-right-radius: 6px; border-bottom-left-radius: 6px; transition: background 0.2s; z-index: 10; }
        .img-item .view-btn:hover { background: #3b82f6; }
        .main-img { border-color: #3b82f6 !important; border-width: 4px !important; }
        .loader { display: inline-block; border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6; width: 20px; height: 20px; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .list-item { display: flex; items-center; padding: 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s; }
        .list-item:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 p-4 md:p-8 font-sans text-gray-800">
    <div class="w-full mx-auto bg-white p-6 md:p-10 rounded-xl shadow-lg border border-gray-100">
        <h2 class="text-3xl font-extrabold mb-8 text-gray-900 border-b pb-4">Shopify Bulk Importer Pro</h2>
        
        <div id="step1" class="space-y-6">
            <h3 class="text-xl font-bold text-gray-700 mb-2">Step 1: Target Destination</h3>
            <p class="text-sm text-gray-500 mb-4">Select the collections and tags that will be applied to all imported products.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="relative">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Target Collections</label>
                    <button id="colDropdownBtn" type="button" class="w-full bg-white border border-gray-300 p-3 rounded-lg flex justify-between items-center text-gray-700 hover:border-blue-500 focus:outline-none transition">
                        <span id="colDropdownText" class="truncate font-medium">Select Collections</span>
                        <span class="text-xs text-gray-400">‚ñº</span>
                    </button>
                    <div id="colDropdownMenu" class="dropdown-menu">
                        <input type="text" id="colSearch" placeholder="Search collections..." class="w-full p-3 border-b border-gray-200 focus:outline-none text-sm">
                        <div id="colList" class="max-h-60 overflow-y-auto p-2">
                            <p class="text-sm text-gray-500 italic p-2">Loading all collections...</p>
                        </div>
                    </div>
                    <div id="selectedColsContainer" class="flex flex-wrap gap-2 mt-3"></div>
                </div>

                <div class="relative">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Global Tags (Multi-select)</label>
                    <button id="tagDropdownBtn" type="button" class="w-full bg-white border border-gray-300 p-3 rounded-lg flex justify-between items-center text-gray-700 hover:border-blue-500 focus:outline-none transition">
                        <span id="tagDropdownText" class="truncate font-medium">Select Tags</span>
                        <span class="text-xs text-gray-400">‚ñº</span>
                    </button>
                    <div id="tagDropdownMenu" class="dropdown-menu">
                        <input type="text" id="tagSearch" placeholder="Search or add custom tag (Press Enter)" class="w-full p-3 border-b border-gray-200 focus:outline-none text-sm">
                        <div id="tagList" class="max-h-60 overflow-y-auto p-2">
                            <p class="text-sm text-gray-500 italic p-2">Loading tags from store...</p>
                        </div>
                    </div>
                    <div id="selectedTagsContainer" class="flex flex-wrap gap-2 mt-3"></div>
                </div>
            </div>

            <div class="mt-8 flex justify-end border-t pt-6">
                <button onclick="goToStep2()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition transform hover:scale-105">
                    Next Step ‚ûî
                </button>
            </div>
        </div>

        <div id="step2" class="hidden space-y-6">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h3 class="text-xl font-bold text-gray-700">Step 2: Fetch & Import</h3>
                <button onclick="goToStep1()" class="text-sm text-blue-600 hover:underline font-semibold">
                    ‚Üê Back to Settings
                </button>
            </div>

            <div class="bg-blue-50 p-6 rounded-lg border border-blue-100 mb-8">
                <label class="block text-sm font-bold text-gray-800 mb-2">Vendor Collection URL</label>
                <div class="flex flex-col md:flex-row gap-3">
                    <input type="text" id="collectionUrl" placeholder="https://vendor.com/collections/all" class="flex-1 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                    <button onclick="fetchCollection()" id="loadBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-8 py-4 rounded-lg shadow-md flex items-center justify-center transition whitespace-nowrap">
                        Load Products <div id="spinner" class="loader border-white border-t-transparent hidden" style="display:none;"></div>
                    </button>
                </div>
            </div>

            <div id="bulkEditSection" class="hidden bg-gray-100 p-5 rounded-lg border border-gray-200 mb-6 flex flex-wrap gap-4 items-end shadow-sm">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Apply Global Title</label>
                    <input type="text" id="globalTitle" class="p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500 w-48" placeholder="Product Title">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Apply Global Price</label>
                    <input type="number" step="0.01" id="globalPrice" class="p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500 w-32" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Apply Global SKU</label>
                    <input type="text" id="globalSku" class="p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500 w-48" placeholder="SKU-ALL">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Apply Global Vendor</label>
                    <input type="text" id="globalVendor" class="p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500 w-48" placeholder="Vendor Name">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Apply Global Qty</label>
                    <input type="number" id="globalQty" class="p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500 w-32" placeholder="0">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Apply Global Type</label>
                    <input type="text" id="globalType" class="p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500 w-48" placeholder="Product Type">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Apply Global Status</label>
                    <select id="globalStatus" class="p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500 w-32">
                        <option value="">-- Select --</option>
                        <option value="active">Active</option>
                        <option value="draft">Draft</option>
                    </select>
                </div>
                <div class="flex gap-2 flex-wrap items-center">
                    <button onclick="applyGlobalSettings()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded shadow transition">
                        Apply to All
                    </button>
                    <button onclick="applyGlobalMoveToType()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded shadow transition" title="Move all existing Product Titles to Type and clear Title boxes">
                        Move All Titles to Type ‚ûî
                    </button>
                    <div class="ml-auto flex items-center gap-4 bg-white p-2 rounded border border-gray-300 shadow-sm">
                        <label class="flex items-center space-x-2 cursor-pointer text-sm font-bold text-gray-800">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" class="w-5 h-5 text-blue-600 rounded cursor-pointer border-gray-300 focus:ring-blue-500">
                            <span>Select All</span>
                        </label>
                        <button id="bulkUploadBtn" onclick="startBulkUpload()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded shadow-lg transition transform hover:scale-105">
                            Upload Selected Products
                        </button>
                    </div>
                </div>
            </div>

            <div id="productContainer"></div>

            <div id="loadMoreDiv" class="hidden text-center mt-8 border-t pt-8">
                <button onclick="loadNextBatch()" id="loadMoreBtn" class="bg-gray-800 hover:bg-gray-900 text-white font-bold px-10 py-4 rounded-lg shadow-md flex items-center justify-center transition mx-auto text-lg">
                    Load More Products
                </button>
            </div>

        </div>
    </div>

    <div id="imageModal" class="hidden fixed inset-0 z-[100] bg-black bg-opacity-80 flex justify-center items-center backdrop-blur-sm">
        <span onclick="closeImageModal()" class="absolute top-5 right-8 text-white text-5xl cursor-pointer hover:text-gray-300 transition">&times;</span>
        <img id="modalImage" src="" class="max-w-[90vw] max-h-[90vh] rounded shadow-2xl border-4 border-white object-contain">
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbywFzQu0m-wMkHFGAAy7irzlX20ixCBUqXEQfpmhlqNhG_Fa3113c9ufOvJxheDbUEO/exec"; 
        
        let allCollections = [];
        let storeTags = [];
        let selectedCollections = [];
        let selectedTags = [];
        
        // Variables for Smart Pagination (Load More)
        let currentProducts = [];
        let allHandles = [];
        let loadedCount = 0;
        let vendorBaseUrl = "";
        const BATCH_SIZE = 10; 

        document.addEventListener('DOMContentLoaded', loadStoreData);


 function toggleSelectAll() {
            const isChecked = document.getElementById('selectAllCheckbox').checked;
            const checkboxes = document.querySelectorAll('.product-select-checkbox');
            checkboxes.forEach(cb => cb.checked = isChecked);
        }

        // Error message show korar notun function ekhane add kora holo
        function showCardError(index, msg) {
            const card = document.getElementById(`card-${index}`);
            if (!card) return;
            let errDiv = document.getElementById(`err-${index}`);
            if (!errDiv) {
                errDiv = document.createElement('div');
                errDiv.id = `err-${index}`;
                errDiv.className = "mt-4 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 font-medium text-sm rounded shadow-sm";
                card.appendChild(errDiv);
            }
            errDiv.innerText = msg;
        }

        let isBulkUploading = false;

        async function startBulkUpload() {
            if (isBulkUploading) return;
            
            const selectedCheckboxes = document.querySelectorAll('.product-select-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert("Please select at least one product to upload.");
                return;
            }

            const activeCards = Array.from(selectedCheckboxes).map(cb => cb.closest('.product-card'));

            isBulkUploading = true;
            const bulkBtn = document.getElementById('bulkUploadBtn');
            const originalBtnText = bulkBtn.innerText;
            bulkBtn.innerText = "Processing Selected...";
            bulkBtn.classList.replace('bg-green-600', 'bg-gray-600');
            bulkBtn.disabled = true;

            for (let i = 0; i < activeCards.length; i++) {
                const card = activeCards[i];
                if (!document.body.contains(card)) continue;

                const index = card.id.split('-')[1];
                const btn = document.getElementById(`upBtn-${index}`);
                
                if (!btn || btn.disabled) continue;

                await uploadToShopify(index);

                let nextCardIndex = -1;
                for (let j = i + 1; j < activeCards.length; j++) {
                    if (document.body.contains(activeCards[j])) {
                        nextCardIndex = j;
                        break;
                    }
                }

                if (nextCardIndex !== -1) {
                    const nextCard = activeCards[nextCardIndex];
                    const nextIndex = nextCard.id.split('-')[1];
                    const nextBtn = document.getElementById(`upBtn-${nextIndex}`);
                    
                    if (nextBtn && !nextBtn.disabled) {
                        for (let t = 7; t > 0; t--) {
                            nextBtn.innerText = `Uploading in ${t}...`;
                            nextBtn.classList.remove('bg-green-600', 'bg-red-600');
                            nextBtn.classList.add('bg-yellow-500');
                            await new Promise(r => setTimeout(r, 1000));
                        }
                        nextBtn.classList.remove('bg-yellow-500');
                        nextBtn.classList.add('bg-green-600');
                    }
                }
            }

            isBulkUploading = false;
            bulkBtn.innerText = originalBtnText;
            bulkBtn.classList.replace('bg-gray-600', 'bg-green-600');
            bulkBtn.disabled = false;
            
            const selectAllCb = document.getElementById('selectAllCheckbox');
            if(selectAllCb) selectAllCb.checked = false;
        }


        async function loadStoreData() {
            try {
                const res = await fetch(WEB_APP_URL + "?action=getStoreData");
                const data = await res.json();
                if(data.status === "success") {
                    allCollections = data.collections;
                    storeTags = data.tags;
                    renderColList();
                    renderTagList();
                }
            } catch (e) { console.error("API Error", e); }
        }

        function goToStep2() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        function goToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }

        const setupDropdown = (btnId, menuId) => {
            document.getElementById(btnId).addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllMenus();
                document.getElementById(menuId).classList.toggle('show');
            });
        };

        setupDropdown('colDropdownBtn', 'colDropdownMenu');
        setupDropdown('tagDropdownBtn', 'tagDropdownMenu');

        function closeAllMenus() {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) closeAllMenus();
        });

        function renderColList(filterText = "") {
            const container = document.getElementById('colList');
            container.innerHTML = "";
            
            const lowerFilter = filterText.toLowerCase();
            let filtered = [];
            
            if (lowerFilter === "") {
                filtered = allCollections;
            } else {
                const exactMatch = [];
                const startsWithMatch = [];
                const includesMatch = [];
                
                allCollections.forEach(c => {
                    const titleLower = c.title.toLowerCase();
                    if (titleLower === lowerFilter) exactMatch.push(c);
                    else if (titleLower.startsWith(lowerFilter)) startsWithMatch.push(c);
                    else if (titleLower.includes(lowerFilter)) includesMatch.push(c);
                });
                
                filtered = [...exactMatch, ...startsWithMatch, ...includesMatch];
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-500 p-2">No match found.</p>`;
                return;
            }

            filtered.forEach(c => {
                const isChecked = selectedCollections.includes(c.id);
                const badge = c.type === 'smart' ? `<span class="text-[10px] bg-indigo-100 text-indigo-800 px-1 rounded ml-2">Automated</span>` : `<span class="text-[10px] bg-green-100 text-green-800 px-1 rounded ml-2">Custom</span>`;
                const label = document.createElement('label');
                label.className = "list-item flex items-center space-x-3";
                label.innerHTML = `<input type="checkbox" value="${c.id}" class="col-checkbox w-4 h-4 text-blue-600 rounded" ${isChecked ? 'checked' : ''}><span class="text-sm font-medium">${escapeHtml(c.title)} ${badge}</span>`;
                label.querySelector('input').addEventListener('change', (e) => handleColSelection(c.id, e.target.checked));
                container.appendChild(label);
            });
        }

        function handleColSelection(id, isChecked) {
            if (isChecked) {
                if (!selectedCollections.includes(id)) selectedCollections.push(id);
            } else {
                selectedCollections = selectedCollections.filter(cId => cId !== id);
            }
            document.getElementById('colDropdownText').innerText = selectedCollections.length > 0 ? `${selectedCollections.length} Collection(s)` : "Select Collections";
            updateSelectedColsUI();
            
            const checkboxes = document.querySelectorAll('.col-checkbox');
            checkboxes.forEach(cb => {
                if (cb.value == id) cb.checked = isChecked;
            });
        }

        function updateSelectedColsUI() {
            const container = document.getElementById('selectedColsContainer');
            if(!container) return;
            container.innerHTML = "";
            selectedCollections.forEach(id => {
                const collection = allCollections.find(c => c.id === id);
                if(collection) {
                    const chip = document.createElement('span');
                    chip.className = "inline-flex items-center bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-1 rounded border border-blue-200";
                    chip.innerHTML = `${escapeHtml(collection.title)} <button type="button" onclick="handleColSelection(${id}, false)" class="ml-2 text-blue-500 hover:text-blue-900 focus:outline-none text-lg leading-none">&times;</button>`;
                    container.appendChild(chip);
                }
            });
        }

        function renderTagList(filterText = "") {
            const container = document.getElementById('tagList');
            container.innerHTML = "";
            const uniqueTags = [...new Set([...storeTags, ...selectedTags])];
            
            const lowerFilter = filterText.toLowerCase();
            let filtered = [];
            
            if (lowerFilter === "") {
                filtered = uniqueTags;
            } else {
                const exactMatch = [];
                const startsWithMatch = [];
                const includesMatch = [];
                
                uniqueTags.forEach(t => {
                    const tagLower = t.toLowerCase();
                    if (tagLower === lowerFilter) exactMatch.push(t);
                    else if (tagLower.startsWith(lowerFilter)) startsWithMatch.push(t);
                    else if (tagLower.includes(lowerFilter)) includesMatch.push(t);
                });
                
                filtered = [...exactMatch, ...startsWithMatch, ...includesMatch];
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-500 p-2">Press Enter to add custom tag.</p>`;
                return;
            }

            filtered.forEach(t => {
                const isChecked = selectedTags.includes(t);
                const label = document.createElement('label');
                label.className = "list-item flex items-center space-x-3";
                label.innerHTML = `<input type="checkbox" value="${escapeHtml(t)}" class="tag-checkbox w-4 h-4 text-blue-600 rounded" ${isChecked ? 'checked' : ''}><span class="text-sm font-medium">${escapeHtml(t)}</span>`;
                label.querySelector('input').addEventListener('change', (e) => handleTagSelection(t, e.target.checked));
                container.appendChild(label);
            });
        }

        function handleTagSelection(tag, isChecked) {
            if (isChecked) {
                if (!selectedTags.includes(tag)) selectedTags.push(tag);
            } else {
                selectedTags = selectedTags.filter(t => t !== tag);
            }
            document.getElementById('tagDropdownText').innerText = selectedTags.length > 0 ? `${selectedTags.length} Tag(s) Selected` : "Select Tags";
            updateSelectedTagsUI();
            
            const checkboxes = document.querySelectorAll('.tag-checkbox');
            checkboxes.forEach(cb => {
                if (cb.value === escapeHtml(tag)) cb.checked = isChecked;
            });
        }

        function updateSelectedTagsUI() {
            const container = document.getElementById('selectedTagsContainer');
            if(!container) return;
            container.innerHTML = "";
            selectedTags.forEach(tag => {
                const chip = document.createElement('span');
                chip.className = "inline-flex items-center bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-1 rounded border border-green-200";
                const safeTag = escapeHtml(tag).replace(/'/g, "\\'");
                chip.innerHTML = `${escapeHtml(tag)} <button type="button" onclick="handleTagSelection('${safeTag}', false)" class="ml-2 text-green-600 hover:text-green-900 focus:outline-none text-lg leading-none">&times;</button>`;
                container.appendChild(chip);
            });
        }

        document.getElementById('colSearch').addEventListener('input', (e) => renderColList(e.target.value));
        document.getElementById('tagSearch').addEventListener('input', (e) => renderTagList(e.target.value));

        document.getElementById('tagSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const newTag = e.target.value.trim();
                if (newTag && !selectedTags.includes(newTag)) {
                    selectedTags.push(newTag);
                    if (!storeTags.includes(newTag)) storeTags.push(newTag);
                    handleTagSelection(newTag, true);
                    e.target.value = '';
                    renderTagList();
                }
            }
        });

        // Smart Pagination: Initial Fetch (Handles Only)
        async function fetchCollection() {
            const urlInput = document.getElementById('collectionUrl').value.trim();
            if(!urlInput) return alert("Please enter a valid URL.");
            
            const btn = document.getElementById('loadBtn');
            const spinner = document.getElementById('spinner');
            const container = document.getElementById('productContainer');
            const loadMoreDiv = document.getElementById('loadMoreDiv');
            
            btn.disabled = true; 
            spinner.style.display = "inline-block";
            
            container.innerHTML = `<div class="text-center py-10 text-gray-600 font-bold animate-pulse text-lg">Scanning vendor website for products... Please wait.</div>`;
            document.getElementById('bulkEditSection').classList.add('hidden');
            loadMoreDiv.classList.add('hidden');

            try {
                const response = await fetch(`${WEB_APP_URL}?action=fetchCollectionHandles&url=${encodeURIComponent(urlInput)}`);
                const data = await response.json();
                
                if(data.status === "success") {
                    allHandles = data.handles;
                    vendorBaseUrl = data.baseUrl;
                    loadedCount = 0;
                    currentProducts = [];
                    container.innerHTML = "";
                    
                    document.getElementById('bulkEditSection').classList.remove('hidden');
                    
                    // Trigger the first batch load
                    await loadNextBatch();
                } else {
                    container.innerHTML = `<div class="text-center py-10 text-red-500 font-bold text-xl">Error: ${data.message}</div>`;
                }
            } catch (e) { 
                container.innerHTML = `<div class="text-center py-10 text-red-500 font-bold text-xl">Network Architecture Error.</div>`; 
            } finally { 
                btn.disabled = false; 
                spinner.style.display = "none"; 
            }
        }

        // Smart Pagination: Load Details 10 at a time
        async function loadNextBatch() {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const loadMoreDiv = document.getElementById('loadMoreDiv');
            
            loadMoreBtn.disabled = true; 
            loadMoreBtn.innerText = "Loading details...";
            
            const handlesToLoad = allHandles.slice(loadedCount, loadedCount + BATCH_SIZE);
            if (handlesToLoad.length === 0) return;

            try {
                const response = await fetch(`${WEB_APP_URL}?action=fetchProductBatch&baseUrl=${encodeURIComponent(vendorBaseUrl)}&handles=${encodeURIComponent(handlesToLoad.join(','))}`);
                const data = await response.json();
                
                if(data.status === "success") {
                    appendProducts(data.products); // Append to DOM without resetting previous cards
                    loadedCount += handlesToLoad.length;
                    
                    const remaining = allHandles.length - loadedCount;
                    if (remaining > 0) {
                        loadMoreDiv.classList.remove('hidden');
                        loadMoreBtn.innerText = `Load More Products (Remaining: ${remaining})`;
                    } else {
                        loadMoreDiv.classList.add('hidden');
                    }
                } else {
                    alert("Error loading batch: " + data.message);
                }
            } catch (e) {
                alert("Network error while loading batch.");
            } finally {
                loadMoreBtn.disabled = false;
            }
        }

        function applyGlobalSettings() {
            const title = document.getElementById('globalTitle').value;
            const price = document.getElementById('globalPrice').value;
            const sku = document.getElementById('globalSku').value;
            const vendor = document.getElementById('globalVendor').value;
            const qty = document.getElementById('globalQty').value;
            const type = document.getElementById('globalType').value;
            const status = document.getElementById('globalStatus').value;
            
            currentProducts.forEach((p, idx) => {
                // Ensure we only apply to cards that exist (haven't been uploaded and hidden)
                if (document.getElementById(`card-${idx}`)) {
                    if (title) document.getElementById(`title-${idx}`).value = title;
                    if (price) document.getElementById(`price-${idx}`).value = price;
                    if (sku) document.getElementById(`sku-${idx}`).value = sku;
                    if (vendor) document.getElementById(`vendor-${idx}`).value = vendor;
                    if (qty) document.getElementById(`qty-${idx}`).value = qty;
                    if (type) document.getElementById(`type-${idx}`).value = type;
                    if (status) document.getElementById(`status-${idx}`).value = status;
                }
            });
        }

        function moveToType(index) {
            const titleInput = document.getElementById(`title-${index}`);
            const typeInput = document.getElementById(`type-${index}`);
            if(titleInput.value.trim() !== "") {
                typeInput.value = titleInput.value;
                titleInput.value = "";
            }
            titleInput.focus();
        }

        function applyGlobalMoveToType() {
            currentProducts.forEach((p, index) => {
                if (document.getElementById(`card-${index}`)) {
                    const titleInput = document.getElementById(`title-${index}`);
                    const typeInput = document.getElementById(`type-${index}`);
                    if (titleInput && typeInput && titleInput.value.trim() !== "") {
                        typeInput.value = titleInput.value;
                        titleInput.value = "";
                    }
                }
            });
        }

        // Appends only the newly fetched batch so old edits aren't lost
        function appendProducts(newProducts) {
            const container = document.getElementById('productContainer');
            const startIndex = currentProducts.length;
            
            // Push new items to global array to maintain correct index sync
            currentProducts.push(...newProducts);
            
            newProducts.forEach((p, i) => {
                const index = startIndex + i;
                const defaultType = p.product_type ? p.product_type : p.title;

                const card = document.createElement('div');
                card.id = `card-${index}`;
                card.className = "product-card bg-white shadow-sm hover:shadow-md transition-shadow";
                card.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div class="lg:col-span-8">
                            <div class="flex justify-between items-center mb-1">
    <label class="flex items-center space-x-2 cursor-pointer block text-sm font-bold text-gray-800 bg-blue-50 px-2 py-1 rounded border border-blue-100">
        <input type="checkbox" id="select-${index}" class="product-select-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
        <span>Select Product</span>
    </label>
    <div class="flex gap-2">
        <button onclick="moveToType(${index})" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 transition font-bold" title="Move current title to Product Type and clear title box">
            Move to Type ‚ûî
        </button>
        <button onclick="removeProductCard(${index})" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200 transition font-bold" title="Remove this product from list">
            ‚úñ Remove
        </button>
    </div>
</div>
                            <input type="text" class="w-full p-3 border border-gray-300 rounded mb-4 focus:outline-none focus:border-blue-500 font-medium" value="${escapeHtml(p.title)}" id="title-${index}">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Description (HTML)</label>
                                    <textarea class="w-full p-3 border border-gray-300 rounded h-40 font-mono text-sm focus:outline-none focus:border-blue-500" id="desc-${index}">${escapeHtml(p.body_html || "")}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Product Information (Auto-Scraped)</label>
                                    <textarea class="w-full p-3 border border-gray-300 rounded h-40 font-mono text-sm focus:outline-none focus:border-blue-500" placeholder="Extracted details will appear here or paste manually..." id="extra-${index}">${escapeHtml(p.extra_info || "")}</textarea>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                                <div><label class="block text-sm font-bold text-gray-700 mb-1">Price</label><input type="number" step="0.01" class="w-full p-3 border border-gray-300 rounded" id="price-${index}"></div>
                                <div><label class="block text-sm font-bold text-gray-700 mb-1">SKU</label><input type="text" class="w-full p-3 border border-gray-300 rounded" id="sku-${index}"></div>
                                <div><label class="block text-sm font-bold text-gray-700 mb-1">Vendor</label><input type="text" class="w-full p-3 border border-gray-300 rounded" value="${escapeHtml(p.vendor || "")}" id="vendor-${index}"></div>
                                <div><label class="block text-sm font-bold text-gray-700 mb-1">Qty</label><input type="number" class="w-full p-3 border border-gray-300 rounded" id="qty-${index}"></div>
                                <div><label class="block text-sm font-bold text-gray-700 mb-1">Type</label><input type="text" class="w-full p-3 border border-gray-300 rounded" value="${escapeHtml(defaultType)}" id="type-${index}"></div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Status</label>
                                    <select id="status-${index}" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                                        <option value="active">Active</option>
                                        <option value="draft">Draft</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lg:col-span-4 bg-gray-50 p-5 rounded-lg border border-gray-200 flex flex-col justify-between">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-3 border-b pb-2">Media (Drag to reorder)</label>
                                <div class="img-grid bg-white p-2" id="imgs-${index}"></div>
                            </div>
                            <button onclick="uploadToShopify(${index})" id="upBtn-${index}" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white py-4 rounded-lg font-bold shadow-md uppercase">Upload to Store</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
                renderImagesOnly(index); 
            });
        }
function removeProductCard(index) {
            const card = document.getElementById(`card-${index}`);
            if (card) {
                // Smooth animation diye card ta remove kora
                card.style.opacity = "0";
                setTimeout(() => card.remove(), 300);
            }
        }

        function renderImagesOnly(pIdx) {
            const container = document.getElementById(`imgs-${pIdx}`);
            const p = currentProducts[pIdx];
            if (!container) return; // safety check
            
            if (p.images.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No images.</p>';
                return;
            }
            container.innerHTML = p.images.map((img, imgIdx) => `
                <div class="img-item" draggable="true" ondragstart="dragStart(event, ${pIdx}, ${imgIdx})" ondragover="dragOver(event)" ondrop="drop(event, ${pIdx}, ${imgIdx})">
                    <img src="${img.src}" class="${imgIdx === 0 ? 'main-img' : ''}" title="Drag to change placement">
                    <span class="remove-btn" onclick="removeImg(${pIdx}, ${imgIdx})">√ó</span>
                    <span class="view-btn" onclick="openImageModal('${img.src}')">üëÅÔ∏è</span>
                </div>
            `).join('');
        }

        function dragStart(e, pIdx, imgIdx) { e.dataTransfer.setData("text/plain", JSON.stringify({ pIdx, imgIdx })); }
        function dragOver(e) { e.preventDefault(); }
        function drop(e, targetPIdx, targetImgIdx) {
            e.preventDefault();
            const data = JSON.parse(e.dataTransfer.getData("text/plain"));
            if (data.pIdx === targetPIdx && data.imgIdx !== targetImgIdx) {
                const draggedImg = currentProducts[targetPIdx].images.splice(data.imgIdx, 1)[0];
                currentProducts[targetPIdx].images.splice(targetImgIdx, 0, draggedImg);
                renderImagesOnly(targetPIdx);
            }
        }

        function removeImg(pIdx, imgIdx) {
            currentProducts[pIdx].images.splice(imgIdx, 1);
            renderImagesOnly(pIdx); 
        }

        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.remove('hidden');
        }
        function closeImageModal() { document.getElementById('imageModal').classList.add('hidden'); }
        document.getElementById('imageModal').addEventListener('click', function(e) { if(e.target===this) closeImageModal(); });

        function escapeHtml(unsafe) {
            if(!unsafe) return "";
            return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        async function uploadToShopify(index) {
            const btn = document.getElementById(`upBtn-${index}`);
            btn.innerText = "Processing..."; btn.disabled = true;
            btn.classList.replace('bg-green-600', 'bg-gray-400');

            let mainDesc = document.getElementById(`desc-${index}`).value;
            let extraInfo = document.getElementById(`extra-${index}`).value.trim();
            let finalCombinedHtml = mainDesc;
            
            if (extraInfo !== "") {
                finalCombinedHtml += "<br><br><strong>Product Information:</strong><br>" + extraInfo.replace(/\n/g, "<br>");
            }

            const payload = {
                action: "uploadProduct", collection_ids: selectedCollections, qty: document.getElementById(`qty-${index}`).value || "0",
                product: {
                    title: document.getElementById(`title-${index}`).value, 
                    body_html: finalCombinedHtml,
                    vendor: document.getElementById(`vendor-${index}`).value, 
                    product_type: document.getElementById(`type-${index}`).value,
                    status: document.getElementById(`status-${index}`).value,
                    tags: selectedTags.join(", "),
                    variants: [{ price: document.getElementById(`price-${index}`).value, sku: document.getElementById(`sku-${index}`).value }],
                    images: currentProducts[index].images.map(img => img.src)
                }
            };

            try {
                const res = await (await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) })).json();
                
                if(res.status === "success") {
                    const card = document.getElementById(`card-${index}`);
                    
                    card.innerHTML = `
                        <div class="text-center py-12 bg-green-50 rounded-lg border border-green-200">
                            <h3 class="text-3xl font-extrabold text-green-600 mb-2">‚úì Uploaded Successfully</h3>
                            <p class="text-green-700 font-medium text-lg">Product: ${escapeHtml(payload.product.title)}</p>
                            <p class="text-gray-500 mt-2 text-sm">Removing from queue...</p>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        card.style.opacity = "0";
                        setTimeout(() => card.remove(), 500);
                    }, 1500);
                    return true;

                } else {
                    showCardError(index, "Error: " + res.message);
                    btn.innerText = "Upload Failed"; btn.disabled = false; btn.classList.replace('bg-gray-400', 'bg-red-600');
                    return false;
                }
            } catch (e) { 
                showCardError(index, "Upload failed due to network error."); 
                btn.innerText = "Upload Failed"; btn.disabled = false; btn.classList.replace('bg-gray-400', 'bg-red-600'); 
                return false;
            }
        }
    </script>
</body>
</html>
